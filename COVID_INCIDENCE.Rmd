---
title: "Denmark Covid Incidence (SSI Data)"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { 
    rmarkdown::render(inputFile,
                      encoding=encoding, 
                      output_file=file.path('docs/index.html')) })
---

```{r include=FALSE }
knitr::opts_chunk$set(echo=FALSE, results='hide', message=FALSE, warning=FALSE)

pacman::p_load(openxlsx,tibbletime,tidyverse,lubridate,tidyr,dplyr,tibble,drc,Ryacas,rvest,drc,tabulizer,directlabels,scales)

dtime = as.POSIXct(Sys.time(),tz="Europe/Copenhagen")
timestamp = paste0(month(dtime, label = TRUE, abbr = FALSE)," ")
timestamp = paste0(timestamp,scales::ordinal(day(dtime))," ")
timestamp = paste0(timestamp,year(dtime)," ")
timestamp = paste0(timestamp,hour(dtime),":")
timestamp = paste0(timestamp,format(dtime, "%M")," ")
timestamp = paste0(timestamp,"(",Sys.timezone(),")")

```

A compilation of visualizations and analyses of Danish COVID-19 incidence numbers published daily by Statens Serum Institut (SSI).

Calculations are performed daily at 14:00 CET in line with daily new data packages by SSI.

Numbers from thee most recent two days are excluded, as they are often subject to several revisions.

This report was compiled `r timestamp `.

```{r }

current_url = xml2::read_html("https://covid19.ssi.dk/overvagningsdata/download-fil-med-overvaagningdata") %>%
  html_node("#top > div.main-content > section.rte.w-max.search-results.search-results-files.compact-half > accordions > div:nth-child(2) > div > div > ul > li:nth-child(1) > h5 > a") %>% 
  rvest::html_attr("href")
```


```{r }
## Unzip
temp_dir = tempdir()
zip_path = paste0(temp_dir,"/temp.zip")
download.file(current_url,zip_path, mode="wb")
unzip(zipfile = zip_path,exdir = temp_dir)
```

The following files were downloaded:

```{r echo=TRUE, results= 'asis'}
file.info(list.files(temp_dir))
```

```{r}

dk_population = 5824857

```

```{r }
rolling_sum <- rollify(.f = sum, window = 14)
```


```{r  }

setClass("num.with.commas")
setAs("character", "num.with.commas", 
        function(from) as.numeric(gsub(",", "", from) ) )

num_cols = ncol(read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),
           sep = ";"))

df <-
  read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),
           sep = ";",
           colClasses=rep('character',num_cols)) %>%
  dplyr::slice(c(1:(nrow(.)-4))) %>% # removing last days
  as_tibble()

df$NewPositive <- df  %>% 
  pull(NewPositive) %>% 
  trimws %>% 
  gsub("\\.","",.)

df <- df %>% 
  dplyr::mutate(NewPositive=readr::parse_number(NewPositive)) %>% 
  dplyr::mutate(NewPositive==gsub(pattern = "\\.",replacement = "_",x = NewPositive)) %>% 
  dplyr::mutate(NewPositive==gsub(pattern = ",",replacement = "",x = NewPositive)) %>% 
  dplyr::mutate(Date=ymd(Date),
                NewPositive=as.integer(NewPositive)) %>% 
  dplyr::mutate(ROLLING_SUM=lag(rolling_sum(NewPositive))) %>%
  dplyr::mutate(INCIDENCE=ROLLING_SUM/(dk_population/100000)) %>%
  dplyr::mutate(Date=ymd(Date)) %>%
  dplyr::select(Date,NewPositive,ROLLING_SUM,INCIDENCE)

```

# 14 Day Incidence per 100,000 citizens

Total Danish population (~5.82 million) incidence in the past 14 days per 100,000 citizens since the beginning of the COVID-19 pandemic. Includes exponential curves of 2nd wave and early 3rd wave in 2021.

```{r  }
## DESCENT #1
df.fit.descent <- 
  df %>%
  filter(Date>=ymd("2020-09-29")) %>%
  filter(Date<=ymd("2020-10-14"))

fit.incidence.descent <- 
  lm(log10(INCIDENCE)~Date,data=df.fit.descent)

predicted.incidence.descent <- 
  10^predict(fit.incidence.descent,
             data.frame(Date=seq.Date(ymd("2020-09-29"),ymd("2020-11-01"),by = "1 day")),interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Date=seq.Date(ymd("2020-09-29"),ymd("2020-11-01"),by = "1 day"))

## INCREASE #1
df.fit.increase <- 
  df %>%
  filter(Date>=ymd("2020-10-14")) %>%
  filter(Date<=ymd("2020-11-03"))

fit.incidence.increase <- 
  lm(log10(INCIDENCE)~Date,data=df.fit.increase)

summary(fit.incidence.increase)

predicted.incidence.increase <- 
  10^predict(fit.incidence.increase,
             data.frame(Date=seq.Date(ymd("2020-10-14"),ymd("2020-11-14"),by = "1 day")),interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Date=seq.Date(ymd("2020-10-14"),ymd("2020-11-14"),by = "1 day"))

## INCREASE #2
df.fit.increase_2 <- 
  df %>%
  filter(Date>=ymd("2020-12-01")) %>%
  filter(Date<=ymd("2020-12-22"))

fit.incidence.increase <- 
  lm(log10(INCIDENCE)~Date,data=df.fit.increase_2)

summary(fit.incidence.increase)

predicted.incidence.increase_2 <- 
  10^predict(fit.incidence.increase,
             data.frame(Date=seq.Date(ymd("2020-12-01"),ymd("2021-03-01"),by = "1 day"),interval = "prediction"),
        interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Date=seq.Date(ymd("2020-12-01"),ymd("2021-03-01"),by = "1 day"))

## DESCENT #2
df.fit.descent.2 <- 
  df %>%
  filter(Date>=ymd("2020-12-22")) %>% 
  filter(Date<=ymd("2021-02-16"))

fit.incidence.descent.2 <- 
  lm(log10(INCIDENCE)~Date,data=df.fit.descent.2)

summary(fit.incidence.descent.2)

predicted.incidence.descent.2 <- 
  10^predict(fit.incidence.descent.2,
             data.frame(Date=seq.Date(ymd("2020-12-22"),ymd("2021-02-16"),by = "1 day"),interval = "prediction"),
        interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Date=seq.Date(ymd("2020-12-22"),ymd("2021-02-16"),by = "1 day"))

## INCREASE 3
df.fit.increase.3 <- 
  df %>%
  filter(Date>=ymd("2021-02-16"))

fit.incidence.increase.3 <- 
  lm(log10(INCIDENCE)~Date,data=df.fit.increase.3)

summary(fit.incidence.increase.3)

predicted.incidence.increase.3 <- 
  10^predict(fit.incidence.increase.3,
             data.frame(Date=seq.Date(ymd("2021-02-16"),ymd("2021-07-01"),by = "1 day"),interval = "prediction"),
        interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Date=seq.Date(ymd("2021-02-16"),ymd("2021-07-01"),by = "1 day"))


```

```{r }

recent_30_days = df %>% 
  tail(30) 

colnames(recent_30_days) = c("Date",
                                        "Daily New Positive Cases",
                                        "14 Day Cumulative Cases",
                                        "14 Day Incidence Per 100K")

```

```{r  }
# PLOT
df %>%
  ggplot(.,aes(x=Date,y=INCIDENCE)) +
  geom_point(size=0.8) +
  geom_abline(slope = -1,intercept = 200) +
  
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=fit),color="blue") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=fit),color="green") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=upr),color="black") +
  
  geom_vline(xintercept = unique(floor_date(seq.Date(dmy("01-02-2020"),dmy("01-08-2030"),by="1 day"),"month")),color="gray70") +
  geom_hline(yintercept = seq(100,1000,by=100),color="gray70") + 
  
  scale_x_date(date_breaks = "1 month",limits=c(dmy("01-02-2020"),dmy("01-07-2021")),date_labels = "%Y %b") +
  scale_y_continuous(limits=c(0,1000),breaks=seq(0,1000,by=50),expand=c(0,0)) +
  
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  
  labs(x="Date",y="14-day Incidence Per 100,000")
```

# 2021 Developments

```{r }

# PLOT
df %>%
  ggplot(.,aes(x=Date,y=INCIDENCE)) +
  geom_point() +
  
  geom_abline(slope = -1,intercept = 200) +
  
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=fit),color="blue") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=fit),color="green") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=fit),color="green") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=upr),color="black") +
  
  geom_vline(xintercept = unique(floor_date(seq.Date(dmy("01-01-2021"),dmy("01-07-2021"),by="1 day"),"month")),color="gray70") +
  geom_hline(yintercept = seq(0,500,by=100),color="gray70") + 
  
  scale_x_date(date_breaks = "14 days",limits=c(dmy("01-01-2021"),dmy("01-07-2021")),date_labels = "%Y %b") +
  scale_y_continuous(limits=c(0,500),breaks=seq(0,500,by=25),expand=c(0,0)) +
  
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="14-day Incidence Per 100,000") 

```

# Most recent 30 days

```{r results="asis", echo = TRUE }

recent_30_days %>% 
  knitr::kable()

```


```{r  }


# PLOT
df %>%
  ggplot(.,aes(x=Date,y=INCIDENCE)) +
  geom_point() +
  scale_x_date(date_breaks = "1 week",limits=c(Sys.Date()-months(1),Sys.Date()),date_labels = "%d %b") +
  scale_y_continuous(limits=c(75,250),breaks=seq(75,500,by=25)) +
  geom_abline(slope = -1,intercept = 200) +
  
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=fit),color="blue") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=fit),color="green") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase_2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=fit),color="yellow") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.descent.2,aes(x=Date,y=upr),color="black") +
  
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=fit),color="red") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase.3,aes(x=Date,y=upr),color="black") +
  
  geom_hline(yintercept = seq(0,1000,by=50),color="gray70") + 
  
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="14-day Incidence Per 100,000") 

```

# 250 Incidence Risk

Identifies municipalities with 7-day incidence numbers per 100,000 above or closing in on the 250 limit.

```{r}

rolling_sum <- rollify(.f = sum, window = 7)

#Befolkningstal 
df.population <- read.csv(paste0(temp_dir,"/Municipality_test_pos.csv"),
           sep = ";", encoding = "UTF-8") %>% 
  dplyr::select(Kommune_.navn.,Befolkningstal) %>% 
  rename(Muni=Kommune_.navn.) %>% 
  dplyr::mutate(Befolkningstal=1000*Befolkningstal)

# Time series
col_number = ncol(read.csv(paste0(temp_dir,"/Municipality_cases_time_series.csv"),
           sep = ";"))

df.250 <-
  read.csv(paste0(temp_dir,"/Municipality_cases_time_series.csv"),
           sep = ";",
           encoding = "UTF-8",
           colClasses=rep("character",col_number)) %>%
    gather(Muni,Value,Roskilde:`Samsø`) %>% 
    dplyr::select(-NA.) %>% 
    dplyr::mutate(Value=as.integer(Value),
                  SampleDate=ymd(SampleDate)) %>% 
  as_tibble() %>% 
  inner_join(df.population) %>% 
  group_by(Muni) %>% 
  arrange(Muni,SampleDate) %>% 
  dplyr::mutate(ROLLING_SUM=lag(rolling_sum(Value))) %>%
  dplyr::mutate(INCIDENCE=ROLLING_SUM/(Befolkningstal/100000)) %>% 
  filter(SampleDate>=Sys.Date()-days(21))

```

```{r echo=TRUE,results='asis'}
df.250 %>% 
  group_by(Muni) %>% 
  filter(SampleDate==max(SampleDate)) %>% 
  dplyr::select(SampleDate,Muni,Befolkningstal,ROLLING_SUM,INCIDENCE) %>% 
  ungroup() %>% 
  arrange(desc(INCIDENCE))
```

```{r}

munis_above_250 = df.250 %>% 
  group_by(Muni) %>% 
  filter(SampleDate==max(SampleDate)) %>% 
  filter(INCIDENCE>=200) %>% 
  .[["Muni"]]

p= df.250  %>% 
  filter(Muni %in% munis_above_250) %>% 
  ggplot(.,aes(x=SampleDate,y=INCIDENCE,color=Muni)) +
  geom_line() +
  theme_bw()+
  theme(legend.position="null") +
  geom_hline(yintercept = 250,color="red",size=0.8,alpha=0.7) +
  geom_hline(yintercept = 200,color="yellow",size=0.8,alpha=0.7) +
  labs(x="Date",y="7-day Incidence Per 100,000") +
  scale_x_date(date_breaks = "2 days",date_labels = "%d %b",expand=c(0,3)) +
  scale_y_continuous(limits=c(0,500),breaks=seq(0,500,by=25))

direct.label(p,list("last.bumpup",cex=1))

```

# Antigen Tests

```{r}

col_number = ncol(read.csv(paste0(temp_dir,"/Antigentests_pr_dag.csv"),
           sep = ";"))


df.antigen_pcr <-
  read.csv(paste0(temp_dir,"/Antigentests_pr_dag.csv"),
           sep = ";",
           colClasses=rep("character",col_number)) %>%
  dplyr::select(Dato,AG_testede,AG_pos,AGpos_PCRpos,AGposPCRneg,AGnegPCRpos,AGnegPCRneg) %>% 
  dplyr::rename(TP=AGpos_PCRpos,
                FP=AGposPCRneg,
                FN=AGnegPCRpos,
                TN=AGnegPCRneg) %>% 
  dplyr::mutate(AG_testede=as.integer(AG_testede),
                TP=as.integer(TP),
                FP=as.integer(FP),
                FN=as.integer(FN),
                TN=as.integer(TN),
                Total=(TP+FP+FN+TN)) %>% 
    dplyr::mutate(TP_frac=TP/Total,
                  FP_frac=FP/Total,
                  FN_frac=FN/Total,
                  TN_frac=TN/Total) %>% 
  dplyr::mutate(Dato=ymd(Dato)) %>% 
  dplyr::mutate(Sensitivity=TP/(TP+FN),
                Specificity=TN/(TN+FP))

```


## Daily Tests over Time

```{r}

ggplot(df.antigen_pcr,aes(x=Dato,y=AG_testede)) +
  geom_line() +
  geom_point() +
  labs(x="Date",y="Number of Tests") +
  scale_y_continuous(labels=scales::comma,expand=c(0,0),breaks=seq(0,500000,by=25000)) +
  scale_x_date(date_breaks = "14 days",date_labels = "%d %b %Y",expand=c(0,3)) +
  theme_bw()

```

## Confusion Matrix (last 7 days)

```{r echo=TRUE,results="asis"}

library(epibasix)

df.antigen_pcr.cm = df.antigen_pcr %>% 
  tail(7) %>% 
  dplyr::mutate(TP=sum(TP),
                FP=sum(FP),
                FN=sum(FN),
                TN=sum(TN)) %>% 
  dplyr::mutate(PPV=TP/(TP+FP),
                NPV=TN/(FN+TN)) %>% 
  slice(c(1)) 

df.antigen_pcr.cm %>% 
  dplyr::select(TP:TN) %>% 
  as.integer %>% 
  matrix(ncol=2,nrow=2) %>% 
  sensSpec(.) %>% 
  summary
  
```

* Sensitivity = ```r scales::percent(df.antigen_pcr.cm$Sensitivity,0.1) ```
* Specificity = ```r scales::percent(df.antigen_pcr.cm$Specificity,0.1) ```

* Positive Predicted Value = ```r scales::percent(df.antigen_pcr.cm$PPV,0.1) ```
* Negative Predicted Value = ```r scales::percent(df.antigen_pcr.cm$NPV,0.1) ```

## Compared to final PCR

```{r}

df.antigen_pcr %>% 
  dplyr::select(Dato,TP_frac:TN_frac) %>% 
  gather(value,num,TP_frac:TN_frac) %>% 
  ggplot(.,aes(x=Dato,y=num,fill=value)) +
  geom_bar(stat="identity") +
  scale_x_date(date_breaks = "14 days",date_labels = "%b %d",expand=c(0,0)) +
  scale_y_continuous(labels = scales::percent,expand=c(0,0),breaks=seq(0,1,by=0.05)) +
  theme_bw()  +
  labs(x="Date",y="Fraction") +
  theme(legend.position="bottom")

```

```{r}
df.antigen_pcr %>% 
  dplyr::select(Dato,TP_frac,FN_frac,FP_frac) %>% 
  gather(value,num,TP_frac:FP_frac) %>% 
  ggplot(.,aes(x=Dato,y=num,color=value)) +
  geom_point() +
  geom_line() +
  scale_x_date(date_breaks = "14 days",date_labels = "%b %d",expand=c(0,0)) +
  scale_y_continuous(labels = scales::percent,expand=c(0,0),breaks=seq(0,1,by=0.01),limits=c(0,0.05)) +
  theme_bw()  +
  labs(x="Date",y="Fraction") +
  theme(legend.position="bottom")
```

```{r}

df.antigen_pcr %>% 
  dplyr::select(Dato,Sensitivity:Specificity) %>% 
  gather(value,num,Sensitivity:Specificity) %>% 
  ggplot(.,aes(x=Dato,y=num,color=value)) +
  geom_line() +
  scale_x_date(date_breaks = "14 days",date_labels = "%b %d",expand=c(0,0)) +
  scale_y_continuous(limits=c(0,1),labels = scales::percent,expand=c(0,0),breaks=seq(0,1,by=0.05)) +
  labs(x="Date",y="%") +
  theme_bw() +
  theme(legend.position="bottom")
```



# Number of Tests

```{r  }

read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),sep=";") %>% 
  slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(Date=ymd(Date),
                Tested=as.integer(gsub("\\.","",Tested))) %>% 
  ggplot(.,aes(x=Date,y=Tested)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="Number of Daily Tests") +
  scale_x_date(date_breaks = "1 month",limits=c(dmy("01-02-2020"),Sys.Date()+days(7)),date_labels = "%b") +
    scale_y_continuous(limits=c(0,350000),breaks=seq(0,350000,by=25000),expand=c(0,0),labels=scales::comma) +
  theme_bw() + 
  geom_smooth(span=0.1)

```

# Regional testing

```{r  }

read.csv(paste0(temp_dir,"/Test_regioner.csv"),sep=";") %>% 
  slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(Date=paste0(ugenr,"-01")) %>% 
  dplyr::mutate(Date=as.Date(paste0(ugenr,"-1"), "%Y-%U-%u")) %>% 
  dplyr::select(-c(7,8,9,10)) %>% 
  gather(Region,Tested,c(2:6)) %>% 
  ggplot(.,aes(x=Date,y=Tested,color=Region)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="Number of Daily Tests") +
  scale_x_date(date_breaks = "1 month",limits=c(dmy("01-02-2020"),Sys.Date()+days(7)),date_labels = "%b") +
  scale_y_continuous(limits=c(0,120000),breaks=seq(0,120000,by=10000),expand=c(0,0),labels=scales::comma) +
  geom_smooth(span=0.1) +
  theme_bw() +
  theme(legend.position="bottom")



```

#  Number of tests vs. positive-% over time

```{r  }

read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),sep=";") %>% 
  slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(Date=ymd(Date),
                Tested=as.integer(gsub("\\.","",Tested)),
                PosPct=as.numeric(gsub("\\,",".",PosPct))/100) %>% 
  dplyr::mutate(Month=paste0(year(Date),"-",months(Date))) %>% 
  filter(Date>=dmy("01-05-2020")) %>% 
  ggplot(.,aes(x=Tested,y=PosPct)) +
  geom_point(aes(color=Month)) +
  geom_smooth(aes(color=Month)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90),legend.position="bottom") +
  labs(x="Number of tests",y="Positive Percentage") +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,1,by=0.0025),labels = scales::percent,expand=c(0,0))+
  scale_x_continuous(limits=c(0,NA),breaks=seq(0,250000,by=10000),labels=scales::comma)



```

# % Positive

## Since March 2020

```{r  }

read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),sep=";") %>% 
  slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(Date=ymd(Date),
                PosPct=as.numeric(gsub("\\,",".",PosPct))/100) %>% 
  ggplot(.,aes(x=Date,y=PosPct)) +
  geom_line() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="% Positive") +
  scale_x_date(date_breaks = "1 month",limits=c(dmy("01-02-2020"),dmy("01-07-2021")),date_labels = "%Y-%b") +
  scale_y_continuous(limits=c(0,NA),labels = scales::percent,expand=c(0,0)) +
  geom_smooth(span=0.2) 

```

## Recent Month

```{r}

read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),sep=";") %>% 
  slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(Date=ymd(Date),
                PosPct=as.numeric(gsub("\\,",".",PosPct))/100) %>% 
  ggplot(.,aes(x=Date,y=PosPct)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="Date",y="% Positive") +
  scale_x_date(date_breaks = "1 day",limits=c(Sys.Date()-months(1),Sys.Date()),date_labels = "%d-%b") +
  scale_y_continuous(limits=c(0,0.01),labels = scales::percent,expand=c(0,0)) +
  geom_smooth(span=0.1,color="black")

```

# Admissions

```{r  }

read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Metric,Value,Hovedstaden:Total) %>% 
  filter(!Metric %in% "Total") %>% 
  dplyr::mutate(Dato=ymd(Dato)) %>% 
  ggplot(.,aes(x=Dato,y=Value,color=Metric,group=Metric)) +
  # geom_point() +
  geom_point() +
  theme_bw() +
  geom_smooth(span=0.1) +
  scale_y_continuous(limits=c(0,NA)) +
  scale_x_date(date_breaks = "1 months",limits=c(dmy("01-02-2020"),dmy("01-07-2021")),date_labels = "%b") +
  theme(legend.position="bottom")

```

```{r}

read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Metric,Value,Hovedstaden:Total) %>% 
  dplyr::mutate(Dato=ymd(Dato)) %>% 
  ggplot(.,aes(x=Dato,y=Value,color=Metric,group=Metric)) +
  geom_point() +
  geom_smooth() +
  theme_bw() +
  scale_x_date(date_breaks = "1 week",date_labels = "%d-%b",limits = c(Sys.Date()-months(1),Sys.Date())) +
  scale_y_continuous(limits=c(0,50))+
  theme(legend.position = "bottom")

```


```{r eval=FALSE}

# Legacy code for when we had a surge in admissions

start = "2020-11-16"
stop = "2021-02-01"

df = 
  read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Metric,Value,Hovedstaden:Total) %>% 
  filter(Metric %in% "Total") %>%
  dplyr::mutate(Dato=ymd(Dato))

## INCREASE #1
df.fit.increase <- 
  df %>%
  filter(Dato>=ymd(start))

fit.incidence.increase <- 
  lm(log10(Value)~Dato,data=df.fit.increase)

summary(fit.incidence.increase)

predicted.incidence.increase <- 
  10^predict(fit.incidence.increase,
             data.frame(Dato=seq.Date(ymd(start),ymd(stop),by = "1 day")),interval = "prediction") %>%
  tbl_df() %>%
  dplyr::mutate(Dato=seq.Date(ymd(start),ymd(stop),by = "1 day"))

## Plot

read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Metric,Value,Hovedstaden:Total) %>% 
  filter(Metric %in% "Total") %>% 
  dplyr::mutate(Dato=ymd(Dato)) %>% 
  ggplot(.,aes(x=Dato,y=Value)) +
  # geom_point() +
  geom_point() +
  geom_smooth() +
  scale_x_date(date_breaks = "4 week",date_labels = "%d-%m",limits=c(ymd(start),ymd(stop))) +
  
  geom_line(data=predicted.incidence.increase,aes(x=Dato,y=fit),color="yellow") +
  geom_line(data=predicted.incidence.increase,aes(x=Dato,y=lwr),color="black") +
  geom_line(data=predicted.incidence.increase,aes(x=Dato,y=upr),color="black")
  

```

# Deaths

```{r}

df.deaths = read.csv(paste0(temp_dir,"/Deaths_over_time.csv"),sep=";") %>% 
  setNames(.,c("Dato","Antal_døde")) %>% 
  slice(c(1:(nrow(.)-2))) %>% 
  dplyr::rename(date=Dato,
         deaths=Antal_døde) %>% 
  dplyr::mutate(date=ymd(date))

ggplot(df.deaths,aes(x=date,y=deaths)) +
  geom_point() +
  geom_smooth(span=0.1) +
  theme_bw() +
  scale_y_continuous(limits=c(0,40)) +
  scale_x_date(date_breaks = "1 month",limits=c(dmy("01-02-2020"),dmy("01-07-2021")),date_labels = "%b") +
  labs(x = "Date", y = "Number of Daily Deaths")

```

# Tests, admissions, deaths

```{r}

# 1. Tests
df.tests <-
  read.csv(paste0(temp_dir,"/Test_pos_over_time.csv"),
           sep=";",
           colClasses=c('character',
                        'character',
                        'character',
                        'character',
                        'character',
                        'character',
                        'character')) %>%
  dplyr::slice(c(1:(nrow(.)-4))) %>% 
  as_tibble() %>% 
  dplyr::mutate(NewPositive=as.integer(gsub("\\.","",trimws(NewPositive))),
                Type="New Positive",
                Date=ymd(Date)) %>% 
  dplyr::select(Date,Type,NewPositive) %>% 
  rename(Value=NewPositive)

# 2. Admissions
df.admissions = read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Type,Value,Hovedstaden:Total) %>% 
  filter(Type %in% "Total") %>% 
  dplyr::mutate(Date=ymd(Dato),
                Type="Admissions") %>% 
  dplyr::select(Date,Type,Value) 

# 3. Deaths
df.deaths = read.csv(paste0(temp_dir,"/Deaths_over_time.csv"),sep=";") %>% 
  setNames(.,c("Dato","Antal_døde")) %>% 
  dplyr::rename(date=Dato,
         deaths=Antal_døde) %>% 
  dplyr::mutate(Date=ymd(date)) %>% 
  gather(Type,Value,deaths) %>% 
  dplyr::select(Date,Type,Value) 

# Bind
df.tests %>% 
  bind_rows(df.admissions) %>% 
  bind_rows(df.deaths) %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_point(aes(group=Type)) +
  geom_smooth(aes(group=Type),span=0.1) +
  facet_wrap(~Type,scales="free",nrow=3) 

```

# Rt

## Official Rt

```{r }

df =
  read.csv(list.files(path = temp_dir,
           pattern = "Rt_cases",full.names = T),sep = ";") %>% 
  rename(date=SampleDate) %>% 
  dplyr::mutate(date=ymd(date),
                estimate=as.numeric(gsub(",","\\.",estimate)),
                uncertainty_lower=as.numeric(gsub(",","\\.",uncertainty_lower)),
                uncertainty_upper=as.numeric(gsub(",","\\.",uncertainty_upper)))


  ggplot(df,aes(x=date,y=estimate)) +
  geom_point() +
  geom_smooth(span=0.1) +
  geom_errorbar(ymin=df$uncertainty_lower,ymax=df$uncertainty_upper,alpha=0.1) +
  theme_bw() +
  geom_hline(yintercept = 1,color="red") +
  scale_y_continuous(limits = c(0,1.4),breaks = seq(0,1.4,by=0.1))

```

## Calculate Rt based on cases

Hidden because of insane CPU demand.

```{r eval=FALSE }

library(EpiNow2)

generation_time <- get_generation_time(disease = "SARS-CoV-2", source = "ganyani")

incubation_period <- get_incubation_period(disease = "SARS-CoV-2", source = "lauer")

reporting_delay <- estimate_delay(rlnorm(1000,  log(3), 1),
                                  max_value = 15, bootstraps = 1)


reported_cases = read.csv(paste0(temp_dir,"/Newly_admitted_over_time.csv"),sep=";") %>% 
  dplyr::select(c(1:6,8)) %>% 
  setNames(.,c("Dato","Hovedstaden","Sjælland","Syddanmark","Midtjylland","Nordjylland","Total")) %>% 
  gather(Metric,Value,Hovedstaden:Total) %>% 
  filter(Metric %in% "Total") %>% 
  dplyr::select(Dato,Value) %>% 
  rename(date=Dato,
         confirm=Value) %>% 
  dplyr::mutate(date=ymd(date)) %>% 
  slice_max(order_by = date,n = 180) %>% 
  arrange(date)

estimates <- epinow(reported_cases = reported_cases, 
                    generation_time = generation_time,
                    delays = delay_opts(incubation_period, reporting_delay),
                    rt = rt_opts(prior = list(mean = 1, sd = 1)),
                    stan = stan_opts(cores = 6))
names(estimates)

knitr::kable(summary(estimates))

plot(estimates)
Sys.time()

## Visualize own

estimates$estimates$summarised %>% 
  filter(variable=="R") %>% 
  ggplot(.,aes(x=date,y=median)) +
  geom_line() +
  geom_point()

## Compare to sst

df.r_values =
  read.csv(list.files(path = temp_dir,
           pattern = "Rt_cases",full.names = T),sep = ";") %>% 
  rename(date=date_sample) %>% 
  dplyr::mutate(date=ymd(date),
                estimate=as.numeric(gsub(",","\\.",estimate)),
                uncertainty_lower=as.numeric(gsub(",","\\.",uncertainty_lower)),
                uncertainty_upper=as.numeric(gsub(",","\\.",uncertainty_upper)))


estimates$estimates$summarised %>% 
  filter(variable=="R") %>% 
  ggplot(.,aes(x=date,y=median)) +
  geom_line(aes(color=type)) +
  geom_point(aes(color=type)) + 
  geom_ribbon(aes(ymin=lower_90,ymax=upper_90,fill=type),alpha=0.3) +
  geom_point(data = df.r_values,aes(x=date,y=estimate),color="gray60") +
  scale_y_continuous(breaks=seq(0,1.5,by=0.1)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%b",limits=c(dmy("01-03-2020"),dmy("01-07-2021"))) +
  theme_bw() +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = dmy("27-06-2021"))  +
  geom_vline(xintercept = dmy("01-02-2021"))  +
  geom_vline(xintercept = dmy("01-03-2021")) +
  labs(title="Rt-beregning via indlæggelsestal",subtitle = "(Ganyani generation times, Lauer incubation times)",y="Rt-værdier (90%CI) ",x=NULL) +
  annotate(geom="rect",xmin = dmy("01-02-2021"),xmax = dmy("01-03-2021"),ymin = 0.7,ymax = 0.8,fill="green",alpha=0.2) +
  annotate(geom="rect",xmin = dmy("01-02-2021"),xmax = dmy("01-03-2021"),ymin = 0.8,ymax = 0.9,fill="yellow",alpha=0.2) +
  annotate(geom="rect",xmin = dmy("01-02-2021"),xmax = dmy("01-03-2021"),ymin = 0.9,ymax = 1.0,fill="red",alpha=0.2)

```

# Vaccination

```{r  }

#knitr::opts_chunk$set(root.dir = "D:/OneDrive/R/")  # should change the working directory to 'Users/Me/Docs/Proj'

library(openxlsx)
library(ggplot2)
library(tibbletime)
library(lubridate)
library(tabulizer)

```

```{r }
url = "https://covid19.ssi.dk/overvagningsdata/download-fil-med-vaccinationsdata"

current_url = xml2::read_html(url) %>%
  rvest::html_node("#top > div.main-content > section.rte.w-max.search-results.search-results-files.compact-half > accordions > div > div > div > ul > li:nth-child(1) > h5 > a") %>% 
  rvest::html_attr("href")

temp_dir = tempdir()
zip_path = paste0(temp_dir,"/temp2.zip")
download.file(current_url,zip_path, mode="wb")
unzip(zipfile = zip_path,exdir = temp_dir)

```


```{r}

df <-
  read.csv(paste0(temp_dir,"/Vaccine_DB/FaerdigVacc_daekning_DK_prdag.csv"),
           skip=1,
           header=FALSE,
           sep = ",",
           colClasses=c('character',
                        'character',
                        'character',
                        'character',
                        'character',
                        'character')) %>%
  as_tibble()
```


```{r }
df.vaccinations = df %>% 
  setNames(.,c("Vaccination_Date",
               "Geography",
               "N_Completed_Per_Day",
               "N_Population",
               "Pct_Completed_Cumulative",
               "N_Completed_Cumulative")) %>% 
  dplyr::select(-Geography) %>% 
  gather(Stat,Val,c(2:ncol(.))) %>% 
  # dplyr::mutate(Val=gsub("\\.","\\,",Val)) %>% 
  #dplyr::mutate(Val=gsub(",","\\.",Val)) %>% 
  dplyr::mutate(Val=as.numeric(Val)) %>% 
  dplyr::mutate(Vaccination_Date=ymd(Vaccination_Date)) %>% 
  na.omit

```

## Cumulative completed

```{r echo=TRUE }

  df.vaccinations %>% 
  filter(Stat %in% c("N_Completed_Cumulative",
                     "Pct_Completed_Cumulative")) %>% 
  spread(Stat,Val) %>% 
  tail(14) %>% 
  knitr::kable()

```



```{r   }
ggplot(  
  df.vaccinations %>% 
    filter(Stat %in% c("N_Completed_Cumulative",
                       "Pct_Completed_Cumulative")) %>% 
    spread(Stat,Val),
  aes(x=Vaccination_Date,y=N_Completed_Cumulative)) + 
  geom_point() + 
  geom_line() +
  scale_y_continuous(limits = c(0,5900000),expand=c(0,0)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%Y-%b") +
  theme_bw() +
  scale_y_continuous(limits=c(0,NA)) +
  labs(x="Date",y="Cumulative Completed Vaccination")
```

## Daily shots

```{r  }
ggplot(df.vaccinations %>% 
    filter(Stat %in% c("N_Completed_Per_Day",
                       "Pct_Completed_Cumulative")) %>% 
    spread(Stat,Val),aes(x=Vaccination_Date,y=N_Completed_Per_Day)) + 
  geom_point() + 
  geom_line() +
  # scale_y_continuous(limits = c(0,5900000),expand=c(0,0)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%Y-%b") +
  theme_bw()+
  scale_y_continuous(limits=c(0,NA)) +
  labs(x="Date",y="Daily Completed Vaccination")

```

## Asymptotic fit

```{r include=TRUE, results="hide" }
# fitting code

min_date=min(df.vaccinations$Vaccination_Date)
max_date=max(df.vaccinations$Vaccination_Date)

df_dates = data.frame(Vaccination_Date=seq.Date(min_date,max_date,by="1 day")) %>% 
  dplyr::mutate(day_num=row_number())

df.asymp = df.vaccinations %>% 
    inner_join(df_dates) %>% 
    filter(Stat %in% c("N_Completed_Cumulative")) %>% 
    spread(Stat,Val)

y = df.asymp %>% pull(N_Completed_Cumulative)
x = df.asymp %>% pull(day_num)

# fit.sigmoid <- drm(y ~ x, data = df, fct = G.3())
# fit.sigmoid <- drm(y ~ x, data = data.frame(x,y), fct = LL2.4())
fit.sigmoid <- drm(y ~ x, data = data.frame(x,y), fct = AR.2())

# fit.sigmoid <- lm(y~log(x+1))
# fit.sigmoid <- lm(y~log(x+1))
summary(fit.sigmoid)

df.predicted = 
  data.frame(x=seq(0,365,1),
             y_=predict(fit.sigmoid,data.frame(x=seq(0,365,1)),interval = "prediction")) %>% 
  dplyr::mutate(y=NA) %>% 
  dplyr::mutate(Date=seq.Date(dmy("27-12-2020"),dmy("27-12-2020")+days(365),by = "1 day"))
df.predicted[seq(length(y)),"y"] = y
colnames(df.predicted) <- c("x","fit","lwr","upr","y","date")
```
    
```{r eval=F  }
options(scipen=999)

ggplot(df.predicted,aes(x=date,y=fit)) +
  geom_line() +
  geom_point(data=df.predicted,aes(x=date,y=y),color="red",size=3) +
  geom_ribbon(aes(ymin=lwr,ymax=upr),alpha=0.3) +
  theme_bw() +
  # scale_y_continuous(limits=c(0,6000000),breaks = seq(0,6000000,by=250000)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%b") +
  geom_vline(xintercept = Sys.Date(),size=1) +
  geom_vline(xintercept = dmy("27-06-2021"))

ggplot(df.predicted,aes(x=date,y=fit)) +
  geom_line() +
  geom_point(data=df.predicted,aes(x=date,y=y),color="red",size=3) +
  geom_ribbon(aes(ymin=lwr,ymax=upr),alpha=0.3) +
  theme_bw() +
  scale_y_continuous(limits=c(0,6000000),breaks = seq(0,6000000,by=250000)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%b") +
  geom_vline(xintercept = Sys.Date(),size=1) +
  geom_vline(xintercept = dmy("27-06-2021"))

ggplot(df.predicted,aes(x=date,y=fit)) +
  geom_line() +
  geom_point(data=df.predicted,aes(x=date,y=y),color="red",size=3) +
  geom_ribbon(aes(ymin=lwr,ymax=upr),alpha=0.3) +
  theme_bw() +
  scale_y_continuous(limits=c(0,6000000),breaks = seq(0,6000000,by=250000)) +
  scale_x_date(date_breaks = "1 month",date_labels = "%b") +
  geom_vline(xintercept = Sys.Date(),size=1) +
  geom_vline(xintercept = dmy("27-06-2021"))
ggplot(df.predicted,aes(x=date,y=fit)) +
  geom_line() +
  geom_point(data=df.predicted,aes(x=date,y=y),color="red",size=3) +
  geom_ribbon(aes(ymin=lwr,ymax=upr),alpha=0.3) +
  theme_bw() +
  scale_x_date(date_breaks = "1 month",date_labels = "%b",limits=c(min(df.predicted$date),Sys.time())) +
  geom_vline(xintercept = Sys.Date(),size=1) +
  geom_vline(xintercept = dmy("27-06-2021"))


# Limit
x_lim <- ysym("x")      # define x as a symbolic variable
options(scipen=999)
lim(as.numeric(coef(fit.sigmoid)[1])+x_lim*as.numeric(coef(fit.sigmoid)[2]), x_lim, 1000) # limit of sin(x)/x as x approaches 0


```




